main:
  push:
    - runner:
        cpus: 8
      services:
        - docker
        - git-clone-yyds
      imports:
        - https://cnb.cool/eryajf/build-env/-/blob/main/env.yaml
      env:
        IMAGE_NAME: "go-ldap-admin"
        DOCKERHUB_USERNAME: eryajf
        ALIHUB_URL: registry.cn-hangzhou.aliyuncs.com
        ALIHUB_USERNAME: eryajf
        ALIHUB_IMAGE_REPONAME: eryajf
      stages:
        - name: üì¶ ÊûÑÂª∫Âà∂ÂìÅ
          image: docker.cnb.cool/znb/images/debian:all
          script: |
            docker cp $(docker create --rm docker.cnb.cool/opsre/go-ldap-admin-ui):/app/dist public/static/dist
            make gox-linux
        - name: üêã Êé®ÈÄÅÈïúÂÉè
          timeout: 3h
          script: |
            echo ${ALIHUB_TOKEN} | docker login -u ${ALIHUB_USERNAME} --password-stdin ${ALIHUB_URL}
            docker run -d --name buildkitd \
              --security-opt seccomp=unconfined \
              --security-opt apparmor=unconfined \
              --security-opt systempaths=unconfined \
              moby/buildkit:rootless
            docker buildx create --use \
              --name mybuilder \
              --driver remote docker-container://buildkitd
            docker buildx build \
              -t ${ALIHUB_URL}/${ALIHUB_USERNAME}/${IMAGE_NAME} \
              -t ${ALIHUB_URL}/${ALIHUB_USERNAME}/${IMAGE_NAME}:${CNB_BRANCH}_`date "+%Y%m%d%H%M%S"` \
              -t ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE} \
              -t ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}:${CNB_BRANCH}_`date "+%Y%m%d%H%M%S"` \
              --platform=linux/arm64,linux/amd64 . --push